name: PR verify

on:
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: 22.x

jobs:
  generate-resources:
    name: Generate resources
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Generate backend client
        working-directory: ui
        run: |
          npx @openapitools/openapi-generator-cli generate \
            -g typescript-axios \
            -i https://api.apps.rancher.io/api-docs \
            -o autogenerated/client/backend \
            --additional-properties usePromises=true \
            --model-name-suffix=DTO

      - name: Save UI autogenerated resources
        uses: actions/upload-artifact@v4
        with:
          name: ui-autogenerated
          path: ui/autogenerated/

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run markdownlint
        run: npx markdownlint-cli -c ./markdownlint.yml --ignore ui/node_modules --ignore backend/node_modules "**/*.md"

  verify-ui:
    name: Verify UI
    runs-on: ubuntu-latest
    needs: generate-resources
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if UI files changed
        id: ui-changes
        run: |
          git fetch origin main
          if git diff --name-only origin/main...HEAD | grep '^ui/'; then
            echo "changes=true" >> $GITHUB_ENV
          else
            echo "changes=false" >> $GITHUB_ENV
          fi

      - name: Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        if: env.changes == 'true'
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Download results from generate-resources job
        uses: actions/download-artifact@v4
        with:
          name: ui-autogenerated
          path: ui/autogenerated

      - name: Install dependencies
        if: env.changes == 'true'
        working-directory: ui
        run: npm ci

      - name: Build UI
        if: env.changes == 'true'
        working-directory: ui
        run: npm run build
  
  verify-backend:
    name: Verify backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if backend files changed
        id: backend-changes
        run: |
          git fetch origin main
          if git diff --name-only origin/main...HEAD | grep '^backend/'; then
            echo "changes=true" >> $GITHUB_ENV
          else
            echo "changes=false" >> $GITHUB_ENV
          fi

      - name: Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        if: env.changes == 'true'
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        if: env.changes == 'true'
        run: npm ci

      - name: Lint backend
        working-directory: backend
        if: env.changes == 'true'
        run: npm run lint

  verify-docker:
    name: Verify docker build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if docker files changed
        id: dockerfiles-changes
        run: |
          git fetch origin main
          if git diff --name-only origin/main...HEAD | grep -E '^(Dockerfile|docker-compose\.yaml|\.dockerignore)$'; then
            echo "changes=true" >> $GITHUB_ENV
          else
            echo "changes=false" >> $GITHUB_ENV
          fi

      - name: Login to Application Collection
        uses: docker/login-action@v3
        if: env.changes == 'true'
        with:
          registry: dp.apps.rancher.io
          username: ${{ secrets.APPLICATION_COLLECTION_USERNAME }}
          password: ${{ secrets.APPLICATION_COLLECTION_TOKEN }}

      # Ref: https://docs.docker.com/build/ci/github-actions/multi-platform/
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        if: env.changes == 'true'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        if: env.changes == 'true'

      - name: Build image
        uses: docker/build-push-action@v6
        if: env.changes == 'true'
        with:
          platforms: linux/amd64,linux/arm64
          push: false
          tags: rancherlabs/application-collection-extension:latest