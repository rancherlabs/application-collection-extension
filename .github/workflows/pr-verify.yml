name: PR verify

on:
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: 22.x

jobs:
  generate-resources:
    name: Generate Resources
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Generate backend client
        working-directory: ui
        run:  npm run generate-backend-client

      - name: Save UI autogenerated resources
        uses: actions/upload-artifact@v4
        with:
          name: ui-autogenerated
          path: ui/autogenerated/

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run markdownlint
        run: npx markdownlint-cli -c ./markdownlint.yml --ignore ui/node_modules --ignore backend/node_modules "**/*.md"

  verify-ui:
    name: Verify UI
    runs-on: ubuntu-latest
    needs: generate-backend-client
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Check if UI files changed
        id: ui-changes
        run: |
          git fetch origin main
          if git diff --name-only origin/main...HEAD | grep '^ui/'; then
            echo "changes=true" >> $GITHUB_ENV
          else
            echo "changes=false" >> $GITHUB_ENV
          fi

      - name: Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        if: env.changes == 'true'
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        if: env.changes == 'true'
        working-directory: ui
        run: npm ci

      - name: Build UI
        if: env.changes == 'true'
        working-directory: ui
        run: npm run build
  
  verify-backend:
    name: Verify Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Check if backend files changed
        id: backend-changes
        run: |
          git fetch origin main
          if git diff --name-only origin/main...HEAD | grep '^backend/'; then
            echo "changes=true" >> $GITHUB_ENV
          else
            echo "changes=false" >> $GITHUB_ENV
          fi

      - name: Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        if: env.changes == 'true'
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        if: env.changes == 'true'
        run: npm ci

      - name: Lint backend
        working-directory: backend
        if: env.changes == 'true'
        run: npm run lint